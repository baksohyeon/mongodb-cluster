<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Cash Table BOT Test</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background-color: #f5f5f7;
        color: #333;
        text-align: center;
        padding: 20px;
      }
      input {
        margin: 10px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      button {
        padding: 10px 20px;
        background-color: #007aff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      button:hover {
        background-color: #005bb5;
      }
    </style>
  </head>
  <body>
    <h1>Cash Table BOT Test</h1>
    <div>
      <input type="text" id="gameIdInput" placeholder="게임 ID 입력" />
      <input type="text" id="ownerInput" placeholder="방장 ID 입력" />
      <input type="number" id="countInput" placeholder="요청 수 입력" min="1" />
      <input type="text" id="wsId" placeholder="websocket id 입력" />
      <button onClick="reqRegister()">register</button>
    </div>
    <script>
      let serverUrl = "ws://localhost:5050/cs_0"; // 요기는 serverurl
      // let serverUrl = "http://localhost:8080/games/"; // 요기는 serverurl
      // let serverUrl = "http://localhost:8080/games/register"; // 요기는 serverurl
      let gameId = ""; // 게임 ID 입력
      let owner = ""; // 방장 ID 입력
      let count = 1; // 요청 수 입력
      let wsId = "723c8c80dd5de16686f925615d38d9c493c1c91a";

      async function reqRegister() {
        gameId = document.getElementById("gameIdInput").value; // 게임 ID 가져오기
        owner = document.getElementById("ownerInput").value; // 방장 ID 가져오기
        count = parseInt(document.getElementById("countInput").value) || 1; // 요청 수 가져오기

        await fetch("ws://localhost:5050" + wsId, {
          method: "POST",
          mode: "cors",
          cache: "no-cache",
          headers: {
            "Content-Type": "application/json",
          },
          redirect: "follow",
          referrerPolicy: "no-referrer",
          body: JSON.stringify(data),
        })
          .then((ret) => {
            if (ret.ok) {
              ret.json().then((data) => {
                console.log(JSON.stringify(data));
              });
            } else {
              throw "error!!";
            }
          })
          .catch((error) => {
            showToast(`
                <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
                            background-color: rgba(0, 0, 0, 0.8); color: white;
                            border-radius: 10px; padding: 16px;
                            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                  <h3 style="margin: 0 0 8px; font-weight: 600;">요청 완료</h3>
                  <p style="margin: 0; font-size: 14px; line-height: 1.4;">
                    게임 ID: ${gameId}<br>
                    서버 URL: ${serverUrl}<br>
                    처리된 요청: ${i + 1}/${count}<br>
                    방장 ID: ${owner}
                  </p>
                </div>
              `);

            function showToast(message) {
              const toast = document.createElement("div");
              toast.innerHTML = message;
              toast.style.position = "fixed";
              toast.style.bottom = "20px";
              toast.style.left = "50%";
              toast.style.transform = "translateX(-50%)";
              toast.style.zIndex = "9999";
              toast.style.transition = "opacity 0.5s, transform 0.5s";
              toast.style.opacity = "0";
              toast.style.transform = "translateX(-50%) translateY(20px)";

              document.body.appendChild(toast);

              setTimeout(() => {
                toast.style.opacity = "1";
                toast.style.transform = "translateX(-50%) translateY(0)";
              }, 100);

              setTimeout(() => {
                toast.style.opacity = "0";
                toast.style.transform = "translateX(-50%) translateY(20px)";
                setTimeout(() => {
                  document.body.removeChild(toast);
                }, 500);
              }, 3000);
            }
          });

        let ws = new WebSocket("ws://localhost:5050/");
        for (let i = 0; i < count; i++) {
          let clientWs = new WebSocket("ws://localhost:4040/gs_0/" + wsId);
          const chars =
            "ABCDEFGHIJKLMNOPQRSTU VWXYZabcdefghijklmnopqrstuvwxyz0123456789";
          let str = "";
          for (let i = 0; i < 32; i++) {
            str += chars.charAt(Math.floor(Math.random() * chars.length));
          }

          let nick = "";
          for (let i = 0; i < 8; i++) {
            nick += chars.charAt(Math.floor(Math.random() * chars.length));
          }

          let packet = {
            to: { name: "asdf", id: gameId },
            cmd: "join",
            data: {
              uid: str,
              nick: nick,
              password: null,
              profile: 6,
            },
          };

          console.log("fetch:", i);

          ws.onopen = () => {
            console.log("WebSocket connection opened");

            ws.send(JSON.stringify(packet, clientWs)).then((ret) => {
              console.log("ret:", ret);
            });
          };

          ws.onmessage = (event) => {
            console.log("Message from server: ", event.data);
          };

          ws.onerror = (error) => {
            console.error("WebSocket error: ", error);
          };

          ws.onclose = () => {
            console.log("WebSocket connection closed");
          };
          return;
        }
      }
    </script>
  </body>
</html>
